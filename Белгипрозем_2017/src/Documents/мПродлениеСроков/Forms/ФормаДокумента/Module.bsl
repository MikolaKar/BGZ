
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Организация = РаботаСОрганизациями.ПолучитьОрганизациюПоУмолчанию();
		Объект.Ответственный = ПользователиКлиентСервер.ТекущийПользователь();
	КонецЕсли; 
КонецПроцедуры


#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы



#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормы_ИмяТаблицы

&НаКлиенте
Процедура СрокиДоговорПриИзменении(Элемент)
	ТекДанные = Элементы.Сроки.ТекущиеДанные;
	ТекДанные.ВидДокумента = "Доп.согл.";
	ТекДанные.НомерДС = "1";
	Если ЗначениеЗаполнено(ТекДанные.Договор) Тогда
		СписокЭтапов = СрокиДоговорПриИзмененииНаСервере(ТекДанные.Договор);
		
		Если СписокЭтапов.Количество() = 1 Тогда
			ТекДанные.ЭтапДоговора = СписокЭтапов.Получить(0).Значение;
		ИначеЕсли СписокЭтапов.Количество() > 1 Тогда
			ВыбЭл = СписокЭтапов.ВыбратьЭлемент(,);
			Если ВыбЭл <> Неопределено Тогда
				ТекДанные.ЭтапДоговора = ВыбЭл.Значение; 		
			КонецЕсли; 
		Иначе
			Сообщить("Этапов нет!");
		КонецЕсли; 
	КонецЕсли; 
КонецПроцедуры

&НаКлиенте
Процедура СрокиЭтапДоговораНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	ТекДанные = Элементы.Сроки.ТекущиеДанные;
	Если ЗначениеЗаполнено(ТекДанные.Договор) Тогда
		ДанныеВыбора = СрокиДоговорПриИзмененииНаСервере(ТекДанные.Договор);
		
		Если ДанныеВыбора.Количество() = 1 Тогда
			ТекДанные.ЭтапДоговора = ДанныеВыбора.Получить(0).Значение;
		КонецЕсли; 
	КонецЕсли; 
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура СрокиЭтапДоговораПриИзменении(Элемент)
	ТекДанные = Элементы.Сроки.ТекущиеДанные;
	Если ЗначениеЗаполнено(ТекДанные.ЭтапДоговора) Тогда
		Если ЕстьЗапретИзмененияПлановогоСрока(ТекДанные.ЭтапДоговора) Тогда
			Сообщить("Запрещено изменять плановый срок в этапе: "+ТекДанные.ЭтапДоговора);
			Сообщить("Снимите запрет в этапе!");
		КонецЕсли; 
	КонецЕсли; 
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы



#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция СрокиДоговорПриИзмененииНаСервере(Договор)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	мЭтапыДоговоров.Ссылка КАК ЭтапДоговора
		|ПОМЕСТИТЬ Этапы
		|ИЗ
		|	Справочник.мЭтапыДоговоров КАК мЭтапыДоговоров
		|ГДЕ
		|	мЭтапыДоговоров.Владелец = &Договор
		|	И НЕ мЭтапыДоговоров.ПометкаУдаления
		|	И НЕ мЭтапыДоговоров.ИсключенИзДоговора
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	мДатыДоговоровСрезПоследних.ЭтапДоговора,
		|	мДатыДоговоровСрезПоследних.Дата КАК ПлановыйСрок
		|ПОМЕСТИТЬ Сроки
		|ИЗ
		|	РегистрСведений.мДатыДоговоров.СрезПоследних(
		|			,
		|			ВидДатыДоговора = &ВидДатыДоговора
		|				И ЭтапДоговора В
		|					(ВЫБРАТЬ
		|						Этапы.ЭтапДоговора
		|					ИЗ
		|						Этапы КАК Этапы)) КАК мДатыДоговоровСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВнутренниеДокументы.ДатаРегистрации КАК ДатаДела,
		|	ВнутренниеДокументы.ЭтапДоговора
		|ПОМЕСТИТЬ Дела
		|ИЗ
		|	Справочник.ВнутренниеДокументы КАК ВнутренниеДокументы
		|ГДЕ
		|	ВнутренниеДокументы.ВидДокумента = &ВидДокумента
		|	И ВнутренниеДокументы.ЭтапДоговора В
		|			(ВЫБРАТЬ
		|				Этапы.ЭтапДоговора
		|			ИЗ
		|				Этапы КАК Этапы)
		|	И НЕ ВнутренниеДокументы.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Этапы.ЭтапДоговора,
		|	Сроки.ПлановыйСрок,
		|	Дела.ДатаДела
		|ИЗ
		|	Этапы КАК Этапы
		|		ЛЕВОЕ СОЕДИНЕНИЕ Сроки КАК Сроки
		|		ПО Этапы.ЭтапДоговора = Сроки.ЭтапДоговора
		|		ЛЕВОЕ СОЕДИНЕНИЕ Дела КАК Дела
		|		ПО Этапы.ЭтапДоговора = Дела.ЭтапДоговора";
	
	Запрос.УстановитьПараметр("ВидДатыДоговора", Справочники.мВидыДатДоговоров.ПлановыйСрок);
	Запрос.УстановитьПараметр("ВидДокумента", Справочники.ВидыВнутреннихДокументов.Дело);
	Запрос.УстановитьПараметр("Договор", Договор);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	СписокЭтапов = Новый СписокЗначений;
	
	Пока Выборка.Следующий() Цикл
		СписокЭтапов.Добавить(Выборка.ЭтапДоговора,""+Выборка.ЭтапДоговора+" Плановый: "+Формат(Выборка.ПлановыйСрок, "ДЛФ=D")+" Дата дела: "+Формат(Выборка.ДатаДела, "ДЛФ=D"));
	КонецЦикла;
	
	Возврат СписокЭтапов;

КонецФункции

&НаСервереБезКонтекста
Функция ЕстьЗапретИзмененияПлановогоСрока(ЭтапДоговора)
	Возврат ЭтапДоговора.ЗапретИзмененияПлановогоСрока;	
КонецФункции
 


#КонецОбласти 