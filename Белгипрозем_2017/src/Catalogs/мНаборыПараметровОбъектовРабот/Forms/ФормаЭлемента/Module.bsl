////////////////////////////////////////////////////////////////////////////////
// Процедуры - обработчики событий формы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Для Каждого ПараметрОбъекта Из Объект.ПараметрыОбъекта Цикл
		ТабПараметры.Добавить().ПараметрОбъекта = ПараметрОбъекта.ПараметрОбъекта;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ПодборПараметровВНабор" Тогда
		
		МассивДобавляемых = Новый Массив;
		
		Для Каждого Добавляемый Из Параметр.МассивДобавляемых Цикл
			Отбор = Новый Структура("ПараметрОбъекта", Добавляемый);
			Если ТабПараметры.НайтиСтроки(Отбор).Количество() = 0 Тогда
				МассивДобавляемых.Добавить(Добавляемый);
			КонецЕсли;
		КонецЦикла;
		
		Если МассивДобавляемых.Количество() > 0 Тогда
			ДобавитьПараметры(МассивДобавляемых);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Процедуры - обработчики команд табличных частей формы

&НаКлиенте
Процедура ТабПараметрыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ТабПараметрыПередУдалением(Элемент, Отказ)
	
	ТабПараметрыПередУдалением(Элемент, ТабПараметры);
	МассивУдаляемыхПараметров = Новый Массив;
	
	Для Каждого ВыдСтрока Из Элемент.ВыделенныеСтроки Цикл
		ПараметрОбъекта = Элемент.ДанныеСтроки(ВыдСтрока).ПараметрОбъекта;
		МассивУдаляемыхПараметров.Добавить(ПараметрОбъекта);
		Строки = ТабПараметры.НайтиСтроки(Новый Структура("ПараметрОбъекта", ПараметрОбъекта));
		ТабПараметры.Удалить(Строки[0]);
	КонецЦикла;
	
	Если МассивУдаляемыхПараметров.Количество() > 0 Тогда
		ОповеститьОбИзмененииНабора("Удаление", МассивУдаляемыхПараметров);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТабПараметрыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТаблицаВыбор(Элемент, ВыбраннаяСтрока, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодборПараметров(Команда)
	ВызватьФормуПодбора();
КонецПроцедуры

&НаКлиенте
Процедура ВызватьФормуПодбора()
	
	СтруктрураПараметров = Новый Структура;
	
	МасВыбранных = Новый Массив;
	
	Для Каждого ЭлементСтр Из ТабПараметры Цикл
		МасВыбранных.Добавить(ЭлементСтр.ПараметрОбъекта);
	КонецЦикла;
	
	СтруктрураПараметров.Вставить("МасВыбранных", МасВыбранных);
	
	ОткрытьФорму("Справочник.НаборыПараметровОбъектовРабот.Форма.ПодборПараметров", СтруктрураПараметров, ЭтаФорма, УникальныйИдентификатор);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Служебные процедуры и функции

&НаКлиенте
Процедура ОповеститьОбИзмененииНабора(Операция, МассивПараметров)
	
	Оповестить("ИзменилсяНаборВыбранных", Новый Структура("Операция, МассивПараметров",	Операция, МассивПараметров), ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьПараметры(масДобавлять)
	
	масП = Новый Массив;
	Для Каждого Стр Из ТабПараметры Цикл
		масП.Добавить(Стр.ПараметрОбъекта);
	КонецЦикла;
	
	ОбщийМассивСвойств = Новый Массив;
	
	Если ПроизвестиДобавлениеВыделенныхСвойств(масДобавлять, масП) Тогда
		Модифицированность = Истина;
		
		Для Каждого Параметр Из масП Цикл
			новСтр = ТабПараметры.Добавить();
			новСтр.ПараметрОбъекта = Параметр;
			ОбщийМассивСвойств.Добавить(Параметр);
		КонецЦикла;
		
		ОповеститьОбИзмененииНабора("Добавление", ОбщийМассивСвойств);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроизвестиДобавлениеВыделенныхСвойств(масСсылок, масП)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПараметрыОбъектов.Ссылка КАК ПараметрОбъекта
	|ПОМЕСТИТЬ Временная
	|ИЗ
	|	ПланВидовХарактеристик.ПараметрыОбъектов КАК ПараметрыОбъектов
	|ГДЕ
	|	ПараметрыОбъектов.Ссылка В (&масП)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПараметрыОбъектов.Ссылка
	|ИЗ
	|	ПланВидовХарактеристик.ПараметрыОбъектов КАК ПараметрыОбъектов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Временная КАК Временная
	|		ПО ПараметрыОбъектов.Ссылка = Временная.ПараметрОбъекта
	|ГДЕ
	|	ПараметрыОбъектов.Ссылка В ИЕРАРХИИ(&масСсылок)
	|	И (НЕ ПараметрыОбъектов.ЭтоГруппа)
	|	И Временная.ПараметрОбъекта ЕСТЬ NULL 
	|	И (НЕ ПараметрыОбъектов.ПометкаУдаления)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПараметрыОбъектов.Наименование";
	
	Запрос.УстановитьПараметр("масСсылок", масСсылок);
	Запрос.УстановитьПараметр("масП", масП);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	масП.Очистить();
	
	Если Выборка.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Пока Выборка.Следующий() Цикл
		масП.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

&НаКлиенте
Процедура ТаблицаВыбор(Элемент, ВыбраннаяСтрока, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ПараметрыОткрытия = Новый Структура;
	//ПараметрыОткрытия.Вставить("ОткрываетсяИзНабораПараметров", Истина);
	ПараметрыОткрытия.Вставить("Ключ", Элемент.ДанныеСтроки(ВыбраннаяСтрока).ПараметрОбъекта);
	
	ОткрытьФорму("ПланВидовХарактеристик.ПараметрыОбъектов.Форма.ФормаЭлемента", ПараметрыОткрытия);
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТекущийОбъект.ПараметрыОбъекта.Очистить();
	
	Для Каждого ПараметрОбъекта Из ТабПараметры Цикл
		ТекущийОбъект.ПараметрыОбъекта.Добавить().ПараметрОбъекта = ПараметрОбъекта.ПараметрОбъекта;
	КонецЦикла;
КонецПроцедуры


