
////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

&НаСервере
Процедура УстановитьДоступностьВидимость()
	
	Если ЗначениеЗаполнено(ВыбранныйСертификат) Тогда
		Элементы.ВыбранныйСертификат.ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПараметрыВозвратаПароля()
	
	РезультатВыбора = Новый Структура;
	
	РезультатВыбора.Вставить("ВыбранныйСертификат", ВыбранныйСертификат);
	РезультатВыбора.Вставить("ЗапомнитьПарольКСертификату", Ложь);
	РезультатВыбора.Вставить("ПарольПользователя", ПарольПользователя);
	РезультатВыбора.Вставить("Комментарий", "");
	// Определение настроек криптографии
	НастройкиКриптографии = Неопределено;
	Если ТипЗнч(ВыбранныйСертификат) = Тип("СправочникСсылка.СертификатыЭП") Тогда
		ПрофильНастроекКриптографии = РаботаСЭП.ПрофильНастроекКриптографииПоСертификату(ВыбранныйСертификат.Отпечаток);
		НастройкиКриптографии = Новый Структура(
			"ПровайдерЭП,
			|ПутьМодуляКриптографии,
			|ТипПровайдераЭП,
			|АлгоритмПодписи,
			|АлгоритмХеширования,
			|АлгоритмШифрования");
		ЗаполнитьЗначенияСвойств(НастройкиКриптографии, ПрофильНастроекКриптографии);
	КонецЕсли;
	РезультатВыбора.Вставить("НастройкиКриптографии", НастройкиКриптографии);
	// В случае запроса пароля пользователя из помощника создания соглашения ЭД
	// вместо сертификата приходит его представление.
	Если Не ТипЗнч(ВыбранныйСертификат) = Тип("Строка") Тогда
		РезультатВыбора.Вставить("Отпечаток", ВыбранныйСертификат.Отпечаток);
	КонецЕсли;
	
	Возврат РезультатВыбора;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура Выбрать(Команда)
	
	// Блок проверки на заполненность сертификата ЭП.
	Если Не ЗначениеЗаполнено(ВыбранныйСертификат) Тогда
		Возврат;
	КонецЕсли;
	
	ЭтаФорма.Закрыть(ПараметрыВозвратаПароля());
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ПОЛЕЙ ФОРМЫ

&НаКлиенте
Процедура ВыбранныйСертификатОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Ключ", ВыбранныйСертификат);
	ПараметрыФормы.Вставить("ТолькоПросмотр", Истина);
	ОткрытьФорму("Справочник.СертификатыЭП.Форма.ФормаЭлемента", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПарольПользователяОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, СтандартнаяОбработка)
	
	// Обход ошибки платформы 10109820
	ПарольПользователя = Текст;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Пропускаем инициализацию, чтобы гарантировать получение формы при передаче параметра "АвтоТест".
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	ВидОперации = Параметры.ВидОперации;
	
	СертификатЭП = "";
	Если Параметры.Свойство("СертификатЭП", СертификатЭП) Тогда
		ВыбранныйСертификат = Параметры.СертификатЭП;
	КонецЕсли;
	
	СертификатыЭП = "";
	Если Параметры.Свойство("СертификатыЭП", СертификатыЭП) Тогда
		Если СертификатыЭП.Количество() > 1 Тогда
			Для каждого Сертификат Из СертификатыЭП Цикл
				Если ТипЗнч(Сертификат) = Тип("СправочникСсылка.СертификатыЭП") Тогда
					Элементы.ВыбранныйСертификат.РежимВыбораИзСписка = Истина;
					Элементы.ВыбранныйСертификат.СписокВыбора.Добавить(Сертификат);
				Иначе
					Элементы.ВыбранныйСертификат.РежимВыбораИзСписка = Истина;
					СсылкаНаСертификат = Справочники.СертификатыЭП.НайтиПоРеквизиту("Отпечаток", Сертификат.Отпечаток);
					Элементы.ВыбранныйСертификат.СписокВыбора.Добавить(СсылкаНаСертификат);
				КонецЕсли;
			КонецЦикла;
		Иначе
			Если ТипЗнч(СертификатыЭП[0]) = Тип("СправочникСсылка.СертификатыЭП") Тогда
				ВыбранныйСертификат = СертификатыЭП[0];
			Иначе
				ВыбранныйСертификат = Справочники.СертификатыЭП.НайтиПоРеквизиту("Отпечаток", СертификатыЭП[0].Отпечаток);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	УстановитьДоступностьВидимость();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ЭтаФорма.ОбновитьОтображениеДанных();
	
КонецПроцедуры